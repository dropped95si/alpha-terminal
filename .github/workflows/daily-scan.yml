name: Daily Market Scan -> Publish JSON + Ingest Supabase

on:
  workflow_dispatch: {}
  schedule:
    - cron: "15 21 * * 1-5" # Weekdays 21:15 UTC (~4:15pm NY winter)

permissions:
  contents: write

concurrency:
  group: daily-scan
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python deps
        working-directory: market_ai_kit
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run scan
        working-directory: market_ai_kit
        run: |
          python -m scanner.run --config config.yaml

      - name: Verify payload exists
        run: |
          ls -lah market_ai_kit/output || true
          test -f market_ai_kit/output/full_scan_payload.json

      - name: Ingest scan into Supabase (via Vercel API)
        env:
          INGEST_TOKEN: ${{ secrets.INGEST_TOKEN }}
        run: |
          set -e
          if [ -z "$INGEST_TOKEN" ]; then
            echo "Missing secret INGEST_TOKEN"
            exit 1
          fi
          curl -sS -X POST "https://alpha-terminal-eight.vercel.app/api/ingest-scan" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $INGEST_TOKEN" \
            --data-binary "@market_ai_kit/output/full_scan_payload.json"

      - name: Copy JSON into public/data
        run: |
          set -e
          mkdir -p public/data
          cp market_ai_kit/output/industries.json public/data/industries.json
          cp market_ai_kit/output/early.json public/data/early.json
          cp market_ai_kit/output/ready.json public/data/ready.json
          cp market_ai_kit/output/watch.json public/data/watch.json
          cp market_ai_kit/output/ticker_indicator_profiles.json public/data/ticker_indicator_profiles.json

      - name: Commit and push if changed (same branch)
        run: |
          set -e
          BRANCH="${GITHUB_REF#refs/heads/}"
          git config user.name "alpha-terminal-bot"
          git config user.email "alpha-terminal-bot@users.noreply.github.com"
          git add public/data/*.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Daily scan: update published JSON"
          git push origin "HEAD:${BRANCH}"
